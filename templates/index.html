<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegraph Transmission Theory - Interactive Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #fafbfc;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --accent: #1e3a5f;
            --accent-light: #2d4a6f;
            --border: #e5e7eb;
            --success: #10b981;
            --error: #ef4444;
            --morse-bg: #1f2937;
            --morse-text: #10b981;
        }

        body.dark-mode {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #3b82f6;
            --accent-light: #60a5fa;
            --border: #475569;
            --morse-bg: #0f172a;
            --morse-text: #22d3ee;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            transition: background 0.3s ease, color 0.3s ease;
        }
        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            animation: headerPattern 20s linear infinite;
        }
        @keyframes headerPattern {
            0% { transform: translateX(0); }
            100% { transform: translateX(60px); }
        }
        .header h1 { font-size: 1.6em; font-weight: 700; margin-bottom: 4px; position: relative; z-index: 1; }
        .header p { font-size: 0.9em; opacity: 0.9; position: relative; z-index: 1; }
        .header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 12px;
            z-index: 10;
        }

        /* Dark Mode Toggle */
        .theme-toggle {
            width: 60px;
            height: 30px;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
            border: none;
        }
        .theme-toggle::before {
            content: '‚òÄÔ∏è';
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }
        .theme-toggle::after {
            content: 'üåô';
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }
        .theme-toggle .toggle-ball {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 3px;
            left: 3px;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        body.dark-mode .theme-toggle .toggle-ball {
            transform: translateX(30px);
        }

        /* Sound Toggle */
        .sound-toggle {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        .sound-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .input-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .input-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .input-group { display: flex; flex-direction: column; gap: 6px; }
        .input-group label {
            font-size: 0.75em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .input-group input, .input-group select {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95em;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .btn {
            padding: 12px 28px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -2px rgba(0,0,0,0.3);
        }
        .btn:active {
            transform: translateY(0);
        }
        .step {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .step:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .step-header {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .step-header:hover {
            background: var(--bg-primary);
        }
        .step-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            font-weight: 700;
            margin-right: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .step-title { font-weight: 600; color: var(--accent); flex: 1; transition: color 0.3s; }
        .step-content { padding: 24px; display: none; background: var(--bg-secondary); }
        .step.open .step-content { display: block; animation: slideDown 0.3s ease; }
        .step.open .step-header { background: var(--bg-primary); }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chart-container { position: relative; height: 180px; margin: 16px 0; }
        .formula-box {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px 20px;
            margin: 12px 0;
            font-family: 'Times New Roman', Georgia, serif;
            transition: all 0.3s ease;
        }
        .formula-box .formula {
            font-size: 1.1em;
            color: var(--accent);
        }
        .formula-box .explanation {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 6px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .morse-display {
            font-family: 'Courier New', monospace;
            font-size: 1.6em;
            letter-spacing: 6px;
            padding: 16px 20px;
            background: var(--morse-bg);
            color: var(--morse-text);
            border-radius: 8px;
            margin: 12px 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        .morse-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.1), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            100% { left: 100%; }
        }
        .signal-elements {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            margin: 12px 0;
        }
        .signal-element {
            width: 14px;
            height: 28px;
            border-radius: 3px;
            transition: all 0.2s ease;
        }
        .signal-element.on {
            background: linear-gradient(180deg, var(--accent) 0%, var(--accent-light) 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .signal-element.off { background: var(--border); }
        .info-panel {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
            border-left: 4px solid #3b82f6;
            padding: 16px 20px;
            margin: 12px 0;
            font-size: 0.9em;
            border-radius: 0 8px 8px 0;
        }
        .result-panel {
            padding: 20px;
            border-radius: 8px;
            margin: 12px 0;
        }
        .result-panel.success {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
        }
        .result-panel.error {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 2px solid #ef4444;
        }
        .spectrum-bar {
            display: inline-block;
            width: 8px;
            margin-right: 2px;
            background: linear-gradient(180deg, #3b82f6 0%, #1d4ed8 100%);
            vertical-align: bottom;
            border-radius: 2px 2px 0 0;
        }
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .two-col { grid-template-columns: 1fr; } }
        .slider-group { display: flex; align-items: center; gap: 12px; }
        .slider-group input[type="range"] { flex: 1; accent-color: var(--accent); }
        .slider-value { min-width: 40px; text-align: right; font-weight: 600; color: var(--accent); }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; margin: 12px 0; }
        th, td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--bg-tertiary); font-weight: 600; color: var(--text-primary); }
        .section-divider {
            text-align: center;
            margin: 40px 0 28px;
            font-size: 1.2em;
            font-weight: 700;
            color: var(--accent);
            position: relative;
        }
        .section-divider::before, .section-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 30%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--border), transparent);
        }
        .section-divider::before { left: 0; }
        .section-divider::after { right: 0; }
        .concept-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin: 16px 0; }

        /* Confetti Animation */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Particle Trail */
        .particle-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            opacity: 0;
            animation: particle-float 3s ease-out forwards;
        }
        @keyframes particle-float {
            0% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 0; transform: scale(0) translateY(-50px); }
        }

        /* Glowing effect for active elements */
        .glow {
            animation: glow-pulse 2s ease-in-out infinite;
        }
        @keyframes glow-pulse {
            0%, 100% { box-shadow: 0 0 5px var(--accent), 0 0 10px var(--accent); }
            50% { box-shadow: 0 0 20px var(--accent), 0 0 30px var(--accent); }
        }

        /* Typing cursor animation */
        .typing-cursor {
            display: inline-block;
            width: 3px;
            height: 1.2em;
            background: var(--morse-text);
            margin-left: 4px;
            animation: blink 0.8s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Keyboard shortcut hints */
        .kbd {
            display: inline-block;
            padding: 3px 8px;
            font-size: 0.75em;
            font-family: monospace;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            box-shadow: 0 2px 0 var(--border);
            margin-left: 8px;
        }

        /* Shake animation for wrong answers */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* Pulse animation for correct answers */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Floating animation */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Score counter animation */
        @keyframes countUp {
            from { transform: scale(1.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .score-animate {
            animation: countUp 0.3s ease-out;
        }

        .concept-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        .concept-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .concept-card h4 { color: var(--accent); margin-bottom: 10px; font-size: 1em; }
        .concept-card p { font-size: 0.9em; color: var(--text-secondary); }

        /* Audio Controls */
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 12px 0;
            padding: 12px 16px;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);
            border-radius: 8px;
        }
        .audio-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid white;
            background: transparent;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.2s;
        }
        .audio-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
        .audio-btn.playing { background: #10b981; border-color: #10b981; animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        }
        .audio-waveform {
            flex: 1;
            height: 40px;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .waveform-bar {
            width: 4px;
            background: rgba(255,255,255,0.6);
            border-radius: 2px;
            transition: height 0.1s;
        }
        .audio-speed {
            color: white;
            font-size: 0.85em;
        }
        .audio-speed select {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* Live Signal Animation */
        .signal-animation-container {
            position: relative;
            height: 120px;
            background: #0f172a;
            border-radius: 8px;
            overflow: hidden;
            margin: 16px 0;
        }
        .signal-trace {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .signal-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #10b981;
            border-radius: 50%;
            box-shadow: 0 0 20px #10b981, 0 0 40px #10b981;
            transform: translate(-50%, -50%);
            transition: all 0.05s linear;
        }
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .signal-label {
            position: absolute;
            bottom: 8px;
            right: 12px;
            color: #10b981;
            font-size: 0.75em;
            font-family: monospace;
        }

        /* Signal Flow Overview */
        .signal-flow-overview {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border: 2px solid var(--accent);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(30, 58, 95, 0.15);
        }
        .flow-title {
            text-align: center;
            font-size: 1.1em;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 16px;
        }
        .flow-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .flow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 90px;
        }
        .flow-step:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            border-color: var(--accent);
        }
        .flow-step.active {
            background: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(30, 58, 95, 0.3);
        }
        .flow-step.active .flow-label {
            color: white;
        }
        .flow-step.complete {
            background: #10b981;
            border-color: #10b981;
        }
        .flow-step.complete .flow-label {
            color: white;
        }
        .flow-icon {
            font-size: 1.5em;
            margin-bottom: 6px;
        }
        .flow-label {
            font-size: 0.75em;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
        }
        .flow-arrow {
            font-size: 1.5em;
            color: var(--accent);
            font-weight: bold;
            animation: pulse-arrow 1.5s ease-in-out infinite;
        }
        @keyframes pulse-arrow {
            0%, 100% { opacity: 0.5; transform: translateX(0); }
            50% { opacity: 1; transform: translateX(3px); }
        }

        /* Step Connector Arrows */
        .step-connector {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px 0;
            position: relative;
        }
        .step-connector-arrow {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--accent);
        }
        .step-connector-arrow .arrow-line {
            width: 4px;
            height: 40px;
            background: linear-gradient(180deg, var(--accent), var(--accent-light));
            border-radius: 2px;
        }
        .step-connector-arrow .arrow-head {
            font-size: 2em;
            line-height: 1;
            margin-top: -8px;
        }
        .step-connector-label {
            position: absolute;
            left: 50%;
            transform: translateX(30px);
            background: var(--bg-tertiary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            color: var(--accent);
            font-weight: 600;
            border: 1px solid var(--border);
            white-space: nowrap;
        }

        /* What Happens Here Box */
        .what-happens-box {
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            border: 1px solid #0ea5e9;
            border-left: 4px solid #0ea5e9;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        body.dark-mode .what-happens-box {
            background: linear-gradient(135deg, #1e3a5f 0%, #1a2942 100%);
            border-color: #3b82f6;
        }
        .what-happens-box h4 {
            color: #0369a1;
            margin: 0 0 10px 0;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        body.dark-mode .what-happens-box h4 {
            color: #60a5fa;
        }
        .what-happens-box p {
            color: #0c4a6e;
            margin: 0;
            font-size: 0.9em;
            line-height: 1.6;
        }
        body.dark-mode .what-happens-box p {
            color: #bfdbfe;
        }

        /* Connection to Next Step Box */
        .next-step-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);
            border: 1px solid #f59e0b;
            border-left: 4px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        body.dark-mode .next-step-box {
            background: linear-gradient(135deg, #422006 0%, #2c1503 100%);
            border-color: #fbbf24;
        }
        .next-step-box h4 {
            color: #b45309;
            margin: 0 0 10px 0;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        body.dark-mode .next-step-box h4 {
            color: #fcd34d;
        }
        .next-step-box p {
            color: #78350f;
            margin: 0;
            font-size: 0.9em;
            line-height: 1.6;
        }
        body.dark-mode .next-step-box p {
            color: #fef3c7;
        }

        /* Input/Output Visual */
        .io-visual {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 16px 0;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            flex-wrap: wrap;
        }
        .io-box {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        .io-box.input-box {
            background: #dbeafe;
            border: 2px solid #3b82f6;
        }
        body.dark-mode .io-box.input-box {
            background: #1e3a5f;
        }
        .io-box.output-box {
            background: #d1fae5;
            border: 2px solid #10b981;
        }
        body.dark-mode .io-box.output-box {
            background: #064e3b;
        }
        .io-box .io-label {
            font-size: 0.7em;
            text-transform: uppercase;
            font-weight: 700;
            color: #6b7280;
            margin-bottom: 4px;
        }
        .io-box .io-value {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            font-size: 1.1em;
        }
        .io-arrow {
            font-size: 1.5em;
            color: var(--accent);
        }

        /* Keep old transmission progress for backwards compatibility (hidden) */
        .transmission-progress {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            margin: 16px 0;
        }
        .progress-stage {
            flex: 1;
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.75em;
            color: #6b7280;
            background: #e5e7eb;
            transition: all 0.3s;
        }
        .progress-stage.active {
            background: #1e3a5f;
            color: white;
            transform: scale(1.05);
        }
        .progress-stage.complete {
            background: #10b981;
            color: white;
        }
        .progress-arrow {
            color: #d1d5db;
            font-size: 1.2em;
        }

        /* Interactive Spectrum */
        .spectrum-interactive {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 4px;
            height: 150px;
            padding: 20px;
            background: #0f172a;
            border-radius: 8px;
            margin: 16px 0;
        }
        .spectrum-bar-interactive {
            width: 20px;
            background: linear-gradient(180deg, #3b82f6 0%, #1e40af 100%);
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .spectrum-bar-interactive:hover {
            background: linear-gradient(180deg, #60a5fa 0%, #3b82f6 100%);
            transform: scaleY(1.1);
        }
        .spectrum-bar-interactive .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .spectrum-bar-interactive:hover .tooltip { opacity: 1; }

        /* Historical Timeline */
        .timeline {
            position: relative;
            padding: 20px 0;
            margin: 20px 0;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #1e3a5f;
        }
        .timeline-item {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }
        .timeline-item:nth-child(odd) { flex-direction: row-reverse; }
        .timeline-content {
            width: 45%;
            padding: 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .timeline-dot {
            width: 16px;
            height: 16px;
            background: #1e3a5f;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #1e3a5f;
            z-index: 1;
            margin: 0 20px;
        }
        .timeline-year {
            font-weight: 700;
            color: #1e3a5f;
            font-size: 1.1em;
        }
        .timeline-title {
            font-weight: 600;
            margin: 4px 0;
        }
        .timeline-desc {
            font-size: 0.85em;
            color: #6b7280;
        }

        .tab-container { margin: 16px 0; }
        .tab-buttons { display: flex; gap: 4px; border-bottom: 1px solid #e5e7eb; }
        .tab-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.85em;
            color: #6b7280;
            border-bottom: 2px solid transparent;
        }
        .tab-btn.active { color: #1e3a5f; border-bottom-color: #1e3a5f; }
        .tab-content { display: none; padding: 16px 0; }
        .tab-content.active { display: block; }
        .eye-diagram-canvas { background: #1f2937; border-radius: 4px; }
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }
        .status-badge.good { background: #dcfce7; color: #166534; }
        .status-badge.fair { background: #fef3c7; color: #92400e; }
        .status-badge.poor { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <!-- Confetti Container -->
    <div class="confetti-container" id="confettiContainer"></div>

    <!-- Particle Container -->
    <div class="particle-container" id="particleContainer"></div>

    <div class="header">
        <div class="header-controls">
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode (Press D)">
                <div class="toggle-ball"></div>
            </button>
            <button class="sound-toggle" id="soundToggle" onclick="toggleSound()" title="Toggle Sound Effects (Press S)">
                üîä
            </button>
        </div>
        <h1>‚ö° Telegraph Transmission Theory Visualization</h1>
        <p>Based on Nyquist's "Certain Topics in Telegraph Transmission Theory" (1928)</p>
        <div style="margin-top: 8px; font-size: 0.75em; opacity: 0.7;">
            Press <span class="kbd">Space</span> to play audio ‚Ä¢ <span class="kbd">D</span> dark mode ‚Ä¢ <span class="kbd">S</span> sound effects
        </div>
    </div>

    <div class="container">
        <!-- Input Section -->
        <div class="input-section">
            <div class="input-row">
                <div class="input-group" style="flex: 1;">
                    <label>Message Text</label>
                    <input type="text" id="inputText" value="SOS" placeholder="Enter text to transmit">
                </div>
                <div class="input-group">
                    <label>Channel Bandwidth</label>
                    <div class="slider-group">
                        <input type="range" id="bandwidth" min="3" max="30" value="15">
                        <span id="bandwidthValue" class="slider-value">15</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>Channel Type</label>
                    <select id="channelType">
                        <option value="ideal">Ideal (Brick-wall)</option>
                        <option value="butterworth">Butterworth Filter</option>
                        <option value="rc">RC Low-pass</option>
                    </select>
                </div>
                <button class="btn" onclick="analyzeSignal()">Transmit Signal</button>
            </div>

            <!-- Signal Flow Overview - Shows how all steps connect -->
            <div class="signal-flow-overview" id="signalFlowOverview" style="display: none;">
                <div class="flow-title">üì° Signal Transmission Pipeline</div>
                <div class="flow-steps">
                    <div class="flow-step active" data-step="1">
                        <div class="flow-icon">‚úâÔ∏è</div>
                        <div class="flow-label">Message Input</div>
                    </div>
                    <div class="flow-arrow">‚ü∂</div>
                    <div class="flow-step" data-step="2">
                        <div class="flow-icon">‚ö°</div>
                        <div class="flow-label">Signal Generation</div>
                    </div>
                    <div class="flow-arrow">‚ü∂</div>
                    <div class="flow-step" data-step="3">
                        <div class="flow-icon">üåä</div>
                        <div class="flow-label">Fourier Transform</div>
                    </div>
                    <div class="flow-arrow">‚ü∂</div>
                    <div class="flow-step" data-step="4">
                        <div class="flow-icon">üõ∞Ô∏è</div>
                        <div class="flow-label">Channel Transit</div>
                    </div>
                    <div class="flow-arrow">‚ü∂</div>
                    <div class="flow-step" data-step="5">
                        <div class="flow-icon">üîÆ</div>
                        <div class="flow-label">Reconstruction</div>
                    </div>
                    <div class="flow-arrow">‚ü∂</div>
                    <div class="flow-step" data-step="6">
                        <div class="flow-icon">üéØ</div>
                        <div class="flow-label">Decode & Verify</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 1: Encoding -->
        <div class="step open" id="step1">
            <div class="step-header" onclick="toggleStep(1)">
                <span class="step-number">‚ë†</span>
                <span class="step-title">‚úâÔ∏è Text to Morse Code Encoding</span>
            </div>
            <div class="step-content">
                <div class="info-panel">
                    <strong>The Physics:</strong> Telegraph communication converts text into electrical signals.
                    Morse code uses timing patterns: short pulses (dots) and long pulses (dashes).
                </div>
                <div id="step1-content">
                    <p style="color: #6b7280;">Click "Transmit Signal" to begin the analysis.</p>
                </div>
            </div>
        </div>

        <!-- Step Connector 1‚Üí2 -->
        <div class="step-connector" id="connector1-2" style="display: none;">
            <div class="step-connector-arrow">
                <div class="arrow-line"></div>
                <div class="arrow-head">‚ñº</div>
            </div>
            <div class="step-connector-label">‚ì™‚ë†‚ë° ‚üπ ‚ö° Signal</div>
        </div>

        <!-- Step 2: Signal Generation -->
        <div class="step" id="step2">
            <div class="step-header" onclick="toggleStep(2)">
                <span class="step-number">‚ë°</span>
                <span class="step-title">‚ö° Rectangular Wave Generation (DC Telegraph)</span>
            </div>
            <div class="step-content">
                <!-- What Happens Here -->
                <div class="what-happens-box">
                    <h4>üî¨ What happens here?</h4>
                    <p>We convert the binary message (0s and 1s) into an <strong>electrical signal</strong>.
                    Each bit becomes a voltage level: <strong>‚¨ÜÔ∏è 1 = high voltage</strong>, <strong>‚¨áÔ∏è 0 = low voltage</strong>.
                    This creates a "staircase" or rectangular wave pattern ‚ñÅ‚ñÉ‚ñÅ‚ñÉ‚ñÉ</p>
                </div>

                <!-- Input/Output Visual -->
                <div class="io-visual" id="step2-io">
                    <div class="io-box input-box">
                        <div class="io-label">üì• Input (from Step 1)</div>
                        <div class="io-value" id="step2-input">‚ì™‚ë†‚ë†‚ì™‚ë† Binary</div>
                    </div>
                    <div class="io-arrow">‚üπ</div>
                    <div class="io-box output-box">
                        <div class="io-label">üì§ Output</div>
                        <div class="io-value">‚ö° Rectangular Wave ‚ñÇ‚ñÜ‚ñÇ‚ñÜ‚ñÜ</div>
                    </div>
                </div>

                <div class="formula-box">
                    <div class="formula">f(t) = m<sub>k</sub> for kT ‚â§ t < (k+1)T</div>
                    <div class="explanation">The signal takes value m<sub>k</sub> (0 or 1) during each time unit T</div>
                </div>
                <div class="chart-container" style="height: 150px;">
                    <canvas id="rectangularChart"></canvas>
                </div>
                <div id="step2-content"></div>

                <!-- Connection to Next Step -->
                <div class="next-step-box">
                    <h4>‚è≠Ô∏è Connection to Step 3</h4>
                    <p>This rectangular wave contains <strong>sharp edges ‚ö°</strong> (sudden transitions).
                    To understand how the channel will affect it, we need to break it down into its <strong>frequency components üéº</strong> using Fourier analysis.</p>
                </div>
            </div>
        </div>

        <!-- Step Connector 2‚Üí3 -->
        <div class="step-connector" id="connector2-3" style="display: none;">
            <div class="step-connector-arrow">
                <div class="arrow-line"></div>
                <div class="arrow-head">‚ñº</div>
            </div>
            <div class="step-connector-label">‚àø Analyze Frequencies üéº</div>
        </div>

        <!-- Step 3: Fourier Decomposition -->
        <div class="step" id="step3">
            <div class="step-header" onclick="toggleStep(3)">
                <span class="step-number">‚ë¢</span>
                <span class="step-title">üåä Fourier Series Decomposition</span>
            </div>
            <div class="step-content">
                <!-- What Happens Here -->
                <div class="what-happens-box">
                    <h4>üî¨ What happens here?</h4>
                    <p>We break down the rectangular wave into <strong>simple sine waves ‚àø‚àø‚àø</strong> of different frequencies.
                    Think of it like splitting white light into a rainbow üåà! The sharp corners require <strong>high-frequency components</strong>,
                    while the flat parts are represented by <strong>low-frequency components</strong>.</p>
                </div>

                <!-- Input/Output Visual -->
                <div class="io-visual">
                    <div class="io-box input-box">
                        <div class="io-label">üì• Input (from Step 2)</div>
                        <div class="io-value">‚ö° Rectangular Wave ‚ñÇ‚ñÜ‚ñÇ‚ñÜ‚ñÜ</div>
                    </div>
                    <div class="io-arrow">‚üπ</div>
                    <div class="io-box output-box">
                        <div class="io-label">üì§ Output</div>
                        <div class="io-value">üåä Frequency Spectrum ‚ñÅ‚ñÇ‚ñÉ‚ñÑ‚ñÖ</div>
                    </div>
                </div>

                <div class="formula-box">
                    <div class="formula">f(t) = a‚ÇÄ + Œ£[a‚Çñcos(kœâ‚ÇÄt) + b‚Çñsin(kœâ‚ÇÄt)]</div>
                    <div class="explanation">Any periodic signal can be expressed as a sum of sinusoidal waves at harmonic frequencies</div>
                </div>
                <div class="two-col">
                    <div>
                        <strong style="font-size: 0.9em; color: var(--text-primary);">Frequency Spectrum</strong>
                        <div class="chart-container" style="height: 180px;">
                            <canvas id="spectrumChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <strong style="font-size: 0.9em; color: var(--text-primary);">Fourier Coefficients</strong>
                        <div id="fourierTable" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
                <div class="info-panel">
                    <strong>Key Insight (Nyquist):</strong> The rectangular wave contains infinite harmonics,
                    but we only need frequencies up to the signaling rate for correct reconstruction at sampling points.
                </div>

                <!-- Connection to Next Step -->
                <div class="next-step-box">
                    <h4>‚è≠Ô∏è Connection to Step 4</h4>
                    <p>Now that we know which frequencies are in our signal üìà, we can see what happens when the
                    <strong>communication channel üõ∞Ô∏è</strong> blocks some of them. Real channels have <strong>limited bandwidth ‚äò</strong>
                    and cannot pass all frequencies.</p>
                </div>
            </div>
        </div>

        <!-- Step Connector 3‚Üí4 -->
        <div class="step-connector" id="connector3-4" style="display: none;">
            <div class="step-connector-arrow">
                <div class="arrow-line"></div>
                <div class="arrow-head">‚ñº</div>
            </div>
            <div class="step-connector-label">üì° Transmit via Channel</div>
        </div>

        <!-- Step 4: Channel Transmission -->
        <div class="step" id="step4">
            <div class="step-header" onclick="toggleStep(4)">
                <span class="step-number">‚ë£</span>
                <span class="step-title">üõ∞Ô∏è Channel Transmission (Bandwidth Limiting)</span>
            </div>
            <div class="step-content">
                <!-- What Happens Here -->
                <div class="what-happens-box">
                    <h4>üî¨ What happens here?</h4>
                    <p>The signal travels through a <strong>communication channel</strong> üì∂ (wire, radio, fiber optic).
                    Every channel has a <strong>maximum frequency it can carry</strong> (bandwidth).
                    High frequencies get <strong>blocked ‚õî or weakened</strong>, like how a wall muffles high-pitched sounds üîá!</p>
                </div>

                <!-- Input/Output Visual -->
                <div class="io-visual">
                    <div class="io-box input-box">
                        <div class="io-label">üì• Input (from Step 3)</div>
                        <div class="io-value">üåä All Frequencies ‚ñÅ‚ñÇ‚ñÉ‚ñÑ‚ñÖ‚ñÜ‚ñá</div>
                    </div>
                    <div class="io-arrow">üõ∞Ô∏è</div>
                    <div class="io-box output-box">
                        <div class="io-label">üì§ Output</div>
                        <div class="io-value">üîá Limited Frequencies ‚ñÅ‚ñÇ‚ñÉ‚ñë‚ñë‚ñë‚ñë</div>
                    </div>
                </div>

                <div class="formula-box">
                    <div class="formula">H(f) = { 1 if |f| ‚â§ B, 0 otherwise } (ideal filter)</div>
                    <div class="explanation">The channel acts as a low-pass filter, blocking frequencies above bandwidth B</div>
                </div>
                <div class="chart-container" style="height: 150px;">
                    <canvas id="channelResponseChart"></canvas>
                </div>
                <div id="step4-content"></div>

                <!-- Connection to Next Step -->
                <div class="next-step-box">
                    <h4>‚è≠Ô∏è Connection to Step 5</h4>
                    <p>With some frequency components removed ‚úÇÔ∏è, the signal at the receiver won't look exactly like the original.
                    Let's see what the <strong>reconstructed signal üîÆ</strong> looks like!</p>
                </div>
            </div>
        </div>

        <!-- Step Connector 4‚Üí5 -->
        <div class="step-connector" id="connector4-5" style="display: none;">
            <div class="step-connector-arrow">
                <div class="arrow-line"></div>
                <div class="arrow-head">‚ñº</div>
            </div>
            <div class="step-connector-label">üìª Received Signal „Ä∞Ô∏è</div>
        </div>

        <!-- Step 5: Signal Reconstruction -->
        <div class="step" id="step5">
            <div class="step-header" onclick="toggleStep(5)">
                <span class="step-number">‚ë§</span>
                <span class="step-title">üîÆ Signal Reconstruction at Receiver</span>
            </div>
            <div class="step-content">
                <!-- What Happens Here -->
                <div class="what-happens-box">
                    <h4>üî¨ What happens here?</h4>
                    <p>At the receiver üìª, we combine the frequency components that <strong>made it through the channel</strong>.
                    The result looks <strong>smoother ‚àº‚àº‚àº</strong> than the original rectangular wave because the sharp edges
                    (high frequencies) were removed. Compare the <strong style="color:#10b981;">üü¢ green line</strong> (received) with the <strong style="color:#3b82f6;">üîµ blue line</strong> (original)!</p>
                </div>

                <!-- Input/Output Visual -->
                <div class="io-visual">
                    <div class="io-box input-box">
                        <div class="io-label">üì• Input (from Step 4)</div>
                        <div class="io-value">üîá Limited Frequencies ‚ñÅ‚ñÇ‚ñÉ‚ñë‚ñë</div>
                    </div>
                    <div class="io-arrow">‚üπ</div>
                    <div class="io-box output-box">
                        <div class="io-label">üì§ Output</div>
                        <div class="io-value">üîÆ Smooth Wave ‚àø‚àø‚àø‚àø</div>
                    </div>
                </div>

                <div class="formula-box">
                    <div class="formula">fÃÇ(t) = Œ£(k=0 to B) [a‚Çñcos(kœâ‚ÇÄt) + b‚Çñsin(kœâ‚ÇÄt)]</div>
                    <div class="explanation">Reconstructed signal from limited frequency components</div>
                </div>
                <div class="chart-container" style="height: 180px;">
                    <canvas id="reconstructedChart"></canvas>
                </div>
                <div id="step5-content"></div>

                <!-- Connection to Next Step -->
                <div class="next-step-box">
                    <h4>‚è≠Ô∏è Connection to Step 6</h4>
                    <p>The signal looks different „Ä∞Ô∏è, but can we still <strong>read the original message üìñ</strong>?
                    Nyquist's key insight üß†: if we sample at the <strong>right moments ‚è±Ô∏è</strong> (center of each bit),
                    we can still decode correctly!</p>
                </div>
            </div>
        </div>

        <!-- Step Connector 5‚Üí6 -->
        <div class="step-connector" id="connector5-6" style="display: none;">
            <div class="step-connector-arrow">
                <div class="arrow-line"></div>
                <div class="arrow-head">‚ñº</div>
            </div>
            <div class="step-connector-label">‚è±Ô∏è Sample & Decide üéØ</div>
        </div>

        <!-- Step 6: Sampling and Decoding -->
        <div class="step" id="step6">
            <div class="step-header" onclick="toggleStep(6)">
                <span class="step-number">‚ë•</span>
                <span class="step-title">üéØ Sampling and Decoding</span>
            </div>
            <div class="step-content">
                <!-- What Happens Here -->
                <div class="what-happens-box">
                    <h4>üî¨ What happens here?</h4>
                    <p>We <strong>sample ‚è±Ô∏è</strong> the received signal at the <strong>center of each time slot</strong>
                    (marked with dots ‚óè on the chart). Then we make a decision: if the value is <strong>‚¨ÜÔ∏è &gt; 0.5 ‚Üí it's a 1</strong>;
                    if <strong>‚¨áÔ∏è &lt; 0.5 ‚Üí it's a 0</strong>. This is Nyquist's brilliant insight üí°: even distorted signals
                    can be decoded correctly if sampled at the right time!</p>
                </div>

                <!-- Input/Output Visual -->
                <div class="io-visual">
                    <div class="io-box input-box">
                        <div class="io-label">üì• Input (from Step 5)</div>
                        <div class="io-value">üîÆ Smooth Wave ‚àø‚àø‚àø‚àø</div>
                    </div>
                    <div class="io-arrow">‚üπ</div>
                    <div class="io-box output-box">
                        <div class="io-label">üì§ Output</div>
                        <div class="io-value" id="step6-output">üéØ Binary: ‚ë†‚ì™‚ë†‚ë†‚ì™ ‚úì</div>
                    </div>
                </div>

                <div class="formula-box">
                    <div class="formula">mÃÇ‚Çñ = fÃÇ((k + 0.5)T) ‚Üí threshold ‚Üí decoded bit</div>
                    <div class="explanation">Sample at the center of each time unit and compare to threshold (0.5)</div>
                </div>
                <div class="chart-container" style="height: 180px;">
                    <canvas id="samplingChart"></canvas>
                </div>
                <div id="step6-content"></div>

                <!-- Connection to Next Step -->
                <div class="next-step-box">
                    <h4>‚è≠Ô∏è Connection to Step 7</h4>
                    <p>Let's compare the <strong>original message üì§</strong> with the <strong>decoded message üì•</strong>
                    and analyze any errors ‚ùå. This will show us the limits of the communication system ‚öñÔ∏è!</p>
                </div>
            </div>
        </div>

        <!-- Step Connector 6‚Üí7 -->
        <div class="step-connector" id="connector6-7" style="display: none;">
            <div class="step-connector-arrow">
                <div class="arrow-line"></div>
                <div class="arrow-head">‚ñº</div>
            </div>
            <div class="step-connector-label">‚öñÔ∏è Compare & Verify ‚úì</div>
        </div>

        <!-- Step 7: Results -->
        <div class="step" id="step7">
            <div class="step-header" onclick="toggleStep(7)">
                <span class="step-number">‚ë¶</span>
                <span class="step-title">üìä Transmission Analysis</span>
            </div>
            <div class="step-content">
                <!-- What Happens Here -->
                <div class="what-happens-box">
                    <h4>üî¨ What happens here?</h4>
                    <p>We compare the <strong>original message üì§</strong> with the <strong>decoded message üì•</strong>
                    and calculate the <strong>error rate üìä</strong>. This tells us if our channel has
                    <strong>sufficient bandwidth ‚úÖ</strong> for reliable communication at this speed ‚ö°.</p>
                </div>

                <div id="step7-content"></div>
            </div>
        </div>

        <!-- Advanced Concepts Section Divider -->
        <div class="section-divider">Advanced Concepts from Nyquist's Paper</div>

        <!-- Concept 1: Shape Factor vs Discrimination Factor -->
        <div class="step" id="concept1">
            <div class="step-header" onclick="toggleConcept(1)">
                <span class="step-number" style="background: #059669;">‚í∂</span>
                <span class="step-title">üî∑ Shape Factor and Discrimination Factor</span>
            </div>
            <div class="step-content">
                <div class="info-panel">
                    <strong>Nyquist's Key Insight:</strong> Any telegraph signal can be factored into two independent parts:
                    F(œâ) √ó D(œâ), where F is the Shape Factor (wave form) and D is the Discrimination Factor (intelligence).
                </div>
                <div class="two-col">
                    <div>
                        <h4 style="margin-bottom: 12px; color: #374151;">Shape Factor F(œâ)</h4>
                        <div class="chart-container" style="height: 180px;">
                            <canvas id="shapeFactorChart"></canvas>
                        </div>
                        <div class="formula-box">
                            <div class="formula">F(œâ) = sin(œâT/2)/(œâT/2)</div>
                            <div class="explanation">For rectangular wave: sinc function. Independent of message content.</div>
                        </div>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 12px; color: #374151;">Discrimination Factor D(œâ)</h4>
                        <div class="chart-container" style="height: 180px;">
                            <canvas id="discriminationFactorChart"></canvas>
                        </div>
                        <div class="formula-box">
                            <div class="formula">D(œâ) = Œ£ m‚Çñ ¬∑ e<sup>-jkœâT</sup></div>
                            <div class="explanation">Depends only on magnitude factors m‚Çñ (the message).</div>
                        </div>
                    </div>
                </div>
                <div id="concept1-content"></div>
            </div>
        </div>

        <!-- Concept 2: Band Redundancy -->
        <div class="step" id="concept2">
            <div class="step-header" onclick="toggleConcept(2)">
                <span class="step-number" style="background: #059669;">‚í∑</span>
                <span class="step-title">üî∂ Band Redundancy</span>
            </div>
            <div class="step-content">
                <div class="info-panel">
                    <strong>Fundamental Discovery:</strong> When frequency is divided into bands of width equal to
                    the signaling speed, each band contains IDENTICAL information. They are mutually redundant.
                </div>
                <div class="formula-box">
                    <div class="formula">Band width = S (signaling speed in symbols/sec)</div>
                    <div class="explanation">Only ONE band is necessary and sufficient to determine the original signal.</div>
                </div>
                <div id="bandRedundancyContent"></div>
                <div class="chart-container" style="height: 200px;">
                    <canvas id="bandRedundancyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Concept 3: Nondistorting Waves -->
        <div class="step" id="concept3">
            <div class="step-header" onclick="toggleConcept(3)">
                <span class="step-number" style="background: #059669;">‚í∏</span>
                <span class="step-title">üîπ Nondistorting Waves</span>
            </div>
            <div class="step-content">
                <div class="info-panel">
                    <strong>Key Concept:</strong> A wave can be deformed (not rectangular) but still be "nondistorting"
                    if it produces correct values at sampling instants.
                </div>
                <div class="formula-box">
                    <div class="formula">Criterion: fÃÇ((k + 0.5)T) ‚àù m‚Çñ for all k</div>
                    <div class="explanation">The value at the mid-instant of each time unit equals the magnitude factor.</div>
                </div>
                <div id="nondistortingContent"></div>
                <div class="chart-container" style="height: 200px;">
                    <canvas id="nondistortingChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Concept 4: Ideal Shape Factors -->
        <div class="step" id="concept4">
            <div class="step-header" onclick="toggleConcept(4)">
                <span class="step-number" style="background: #059669;">‚íπ</span>
                <span class="step-title">üìê Ideal Shape Factors (Nyquist's Figure 2)</span>
            </div>
            <div class="step-content">
                <div class="info-panel">
                    <strong>Nyquist's Figure 2:</strong> A family of shape factors that all produce nondistorting waves.
                    The raised cosine filter is the most commonly used today.
                </div>
                <div class="chart-container" style="height: 220px;">
                    <canvas id="idealShapeChart"></canvas>
                </div>
                <div id="idealShapeContent"></div>
            </div>
        </div>

        <!-- Concept 5: Progressive Harmonic Building -->
        <div class="step" id="concept5">
            <div class="step-header" onclick="toggleConcept(5)">
                <span class="step-number" style="background: #059669;">‚í∫</span>
                <span class="step-title">üéº Progressive Harmonic Building</span>
            </div>
            <div class="step-content">
                <div class="info-panel">
                    <strong>Interactive Visualization:</strong> Watch how the signal improves as more harmonics are added.
                    This demonstrates the relationship between bandwidth and signal fidelity.
                </div>
                <div style="margin: 16px 0;">
                    <label style="font-size: 0.85em; color: #6b7280;">Number of Harmonics: </label>
                    <input type="range" id="harmonicSlider" min="1" max="25" value="5" style="width: 200px;">
                    <span id="harmonicValue" style="font-weight: 600;">5</span>
                </div>
                <div class="chart-container" style="height: 200px;">
                    <canvas id="progressiveChart"></canvas>
                </div>
                <div id="progressiveContent"></div>
            </div>
        </div>

        <!-- Concept 6: Carrier Wave Modulation -->
        <div class="step" id="concept6">
            <div class="step-header" onclick="toggleConcept(6)">
                <span class="step-number" style="background: #059669;">‚íª</span>
                <span class="step-title">üìª Carrier Wave Modulation and Sidebands</span>
            </div>
            <div class="step-content">
                <div class="info-panel">
                    <strong>Carrier Telegraphy:</strong> Nyquist showed that amplitude modulation creates
                    symmetric sidebands, requiring TWICE the bandwidth of DC telegraphy.
                </div>
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-btn active" onclick="showCarrierTab('time')">Time Domain</button>
                        <button class="tab-btn" onclick="showCarrierTab('freq')">Frequency Domain</button>
                    </div>
                    <div class="tab-content active" id="carrier-time">
                        <div class="chart-container" style="height: 280px;">
                            <canvas id="carrierTimeChart"></canvas>
                        </div>
                    </div>
                    <div class="tab-content" id="carrier-freq">
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="carrierFreqChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="formula-box">
                    <div class="formula">s(t) = [1 + m(t)] ¬∑ cos(œâ<sub>c</sub>t) ‚Üí Upper + Lower Sidebands</div>
                    <div class="explanation">Baseband B Hz ‚Üí Carrier needs 2B Hz (one per sideband)</div>
                </div>
                <div id="carrierContent"></div>
            </div>
        </div>

        <!-- Concept 7: Single Sideband -->
        <div class="step" id="concept7">
            <div class="step-header" onclick="toggleConcept(7)">
                <span class="step-number" style="background: #059669;">‚íº</span>
                <span class="step-title">üì∂ Single Sideband and Phase Discrimination</span>
            </div>
            <div class="step-content">
                <div class="info-panel">
                    <strong>Bandwidth Recovery:</strong> Nyquist described two methods to overcome carrier inefficiency:
                    <br>1. <strong>Single Sideband (SSB):</strong> Transmit only one sideband
                    <br>2. <strong>Phase Discrimination:</strong> Use I and Q components (doubles capacity)
                </div>
                <div class="two-col">
                    <div class="chart-container" style="height: 180px;">
                        <canvas id="ssbTimeChart"></canvas>
                    </div>
                    <div class="chart-container" style="height: 180px;">
                        <canvas id="ssbFreqChart"></canvas>
                    </div>
                </div>
                <div id="ssbContent"></div>
            </div>
        </div>

        <!-- Concept 8: Eye Diagram -->
        <div class="step" id="concept8">
            <div class="step-header" onclick="toggleConcept(8)">
                <span class="step-number" style="background: #059669;">‚íΩ</span>
                <span class="step-title">üëÅÔ∏è Eye Diagram and Intersymbol Interference</span>
            </div>
            <div class="step-content">
                <div class="info-panel">
                    <strong>Eye Diagram:</strong> A powerful tool for visualizing signal quality.
                    Consecutive symbol periods are overlaid to show ISI and timing margins.
                </div>
                <div class="two-col">
                    <div>
                        <div class="chart-container" style="height: 220px;">
                            <canvas id="eyeChart" class="eye-diagram-canvas"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 12px; color: #374151;">Eye Metrics</h4>
                        <div id="eyeMetrics"></div>
                        <div class="concept-card" style="margin-top: 12px;">
                            <h4>Interpretation</h4>
                            <p><strong>Eye Height:</strong> Noise margin - larger is better</p>
                            <p><strong>Eye Width:</strong> Timing margin for sampling</p>
                            <p><strong>Crossing Points:</strong> Where transitions occur</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historical Timeline -->
        <div class="step" id="timeline">
            <div class="step-header" onclick="toggleStep('timeline')">
                <span class="step-number" style="background: #f59e0b;">‚è≥</span>
                <span class="step-title">üèõÔ∏è Historical Context: The Road to Nyquist</span>
            </div>
            <div class="step-content">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-content">
                            <div class="timeline-year">1837</div>
                            <div class="timeline-title">Morse Code Invented</div>
                            <div class="timeline-desc">Samuel Morse develops the telegraph and Morse code, enabling long-distance electrical communication.</div>
                        </div>
                        <div class="timeline-dot"></div>
                        <div style="width: 45%;"></div>
                    </div>
                    <div class="timeline-item">
                        <div style="width: 45%;"></div>
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-year">1864</div>
                            <div class="timeline-title">Maxwell's Equations</div>
                            <div class="timeline-desc">James Clerk Maxwell publishes his electromagnetic theory, providing the mathematical foundation for all electrical communication.</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-content">
                            <div class="timeline-year">1876</div>
                            <div class="timeline-title">Telephone Invented</div>
                            <div class="timeline-desc">Alexander Graham Bell patents the telephone, demonstrating voice transmission over wires.</div>
                        </div>
                        <div class="timeline-dot"></div>
                        <div style="width: 45%;"></div>
                    </div>
                    <div class="timeline-item">
                        <div style="width: 45%;"></div>
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-year">1924</div>
                            <div class="timeline-title">Nyquist's First Paper</div>
                            <div class="timeline-desc">"Certain Factors Affecting Telegraph Speed" - Nyquist begins exploring the theoretical limits of telegraph transmission.</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-content" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%); color: white;">
                            <div class="timeline-year" style="color: #60a5fa;">1928</div>
                            <div class="timeline-title" style="color: white;">THIS PAPER</div>
                            <div class="timeline-desc" style="color: rgba(255,255,255,0.8);">"Certain Topics in Telegraph Transmission Theory" - The landmark paper establishing the Nyquist rate and sampling theorem foundations.</div>
                        </div>
                        <div class="timeline-dot" style="background: #f59e0b; box-shadow: 0 0 0 2px #f59e0b;"></div>
                        <div style="width: 45%;"></div>
                    </div>
                    <div class="timeline-item">
                        <div style="width: 45%;"></div>
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-year">1948</div>
                            <div class="timeline-title">Shannon's Information Theory</div>
                            <div class="timeline-desc">Claude Shannon publishes "A Mathematical Theory of Communication", building on Nyquist's work to create information theory.</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-content">
                            <div class="timeline-year">Today</div>
                            <div class="timeline-title">Digital Communications</div>
                            <div class="timeline-desc">Every digital system - WiFi, 5G, streaming, internet - uses principles from Nyquist's 1928 paper.</div>
                        </div>
                        <div class="timeline-dot"></div>
                        <div style="width: 45%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="step" id="summary">
            <div class="step-header" onclick="toggleStep('summary')">
                <span class="step-number" style="background: #7c3aed;">‚àë</span>
                <span class="step-title">üìú Summary: Nyquist's Key Contributions</span>
            </div>
            <div class="step-content">
                <div class="concept-grid">
                    <div class="concept-card">
                        <h4>1. Nyquist Rate</h4>
                        <p>S<sub>max</sub> = 2B symbols/second. The fundamental limit relating bandwidth and signaling speed.</p>
                    </div>
                    <div class="concept-card">
                        <h4>2. Band Redundancy</h4>
                        <p>Frequency bands of width S contain identical information. Only one band is needed.</p>
                    </div>
                    <div class="concept-card">
                        <h4>3. Shape/Discrimination Separation</h4>
                        <p>Signal = F(œâ) √ó D(œâ). Allows independent analysis of waveform and message.</p>
                    </div>
                    <div class="concept-card">
                        <h4>4. Nondistorting Waves</h4>
                        <p>Deformed waves can still be correct at sampling instants - only those points matter.</p>
                    </div>
                    <div class="concept-card">
                        <h4>5. Ideal Shape Factors</h4>
                        <p>Family of filters (raised cosine) that achieve zero ISI at sampling instants.</p>
                    </div>
                    <div class="concept-card">
                        <h4>6. Carrier Inefficiency</h4>
                        <p>AM requires 2√ó bandwidth. SSB and phase discrimination restore efficiency.</p>
                    </div>
                </div>

                <!-- Fun Facts -->
                <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px;">
                    <h4 style="color: #92400e; margin-bottom: 12px;">Did You Know?</h4>
                    <ul style="color: #78350f; font-size: 0.9em; margin-left: 20px;">
                        <li style="margin-bottom: 8px;">Harry Nyquist was born in Sweden in 1889 and emigrated to the US at age 18.</li>
                        <li style="margin-bottom: 8px;">He worked at AT&T Bell Labs for 37 years and held 138 patents!</li>
                        <li style="margin-bottom: 8px;">The "Nyquist frequency" in digital audio (44.1 kHz for CDs) is named after him.</li>
                        <li style="margin-bottom: 8px;">His work is why your phone can stream video - bandwidth efficiency matters!</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Quiz Section -->
        <div class="step" id="quiz">
            <div class="step-header" onclick="toggleStep('quiz')">
                <span class="step-number" style="background: #ec4899;">‚ùì</span>
                <span class="step-title">üß† Test Your Knowledge: Quick Quiz</span>
            </div>
            <div class="step-content">
                <div id="quizContainer">
                    <div id="quizQuestion" style="font-size: 1.1em; font-weight: 600; margin-bottom: 16px;"></div>
                    <div id="quizOptions" style="display: flex; flex-direction: column; gap: 8px;"></div>
                    <div id="quizFeedback" style="margin-top: 16px; padding: 12px; border-radius: 6px; display: none;"></div>
                    <div style="margin-top: 16px; display: flex; gap: 12px;">
                        <button class="btn" onclick="nextQuestion()" id="nextBtn" style="display: none;">Next Question</button>
                        <button class="btn" onclick="startQuiz()" id="restartBtn" style="background: #6b7280;">Restart Quiz</button>
                    </div>
                    <div id="quizScore" style="margin-top: 16px; font-weight: 600;"></div>
                </div>
            </div>
        </div>

        <!-- Morse Code Practice -->
        <div class="step" id="practice">
            <div class="step-header" onclick="toggleStep('practice')">
                <span class="step-number" style="background: #14b8a6;">‚å®Ô∏è</span>
                <span class="step-title">üéÆ Practice: Decode Morse Code</span>
            </div>
            <div class="step-content">
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 0.9em; color: #6b7280; margin-bottom: 12px;">Listen to the Morse code and type the letter:</div>
                    <div id="practiceDisplay" style="font-size: 3em; font-family: 'Courier New', monospace; letter-spacing: 8px; padding: 20px; background: #1f2937; color: #10b981; border-radius: 8px; margin-bottom: 16px;">¬∑ ¬∑ ¬∑</div>
                    <button class="btn" onclick="playPracticeCode()" style="margin-bottom: 16px;">Play Sound</button>
                    <div style="display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;">
                        <input type="text" id="practiceInput" maxlength="1" style="width: 60px; height: 60px; font-size: 2em; text-align: center; text-transform: uppercase; border: 2px solid #d1d5db; border-radius: 8px;" onkeyup="checkPracticeAnswer(event)">
                    </div>
                    <div id="practiceFeedback" style="font-size: 1.2em; font-weight: 600;"></div>
                    <div id="practiceScore" style="margin-top: 12px; color: #6b7280;">Score: <span id="practiceCorrect">0</span> / <span id="practiceTotal">0</span></div>
                    <button class="btn" onclick="newPracticeQuestion()" style="margin-top: 12px; background: #14b8a6;">New Letter</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Chart instances
        let rectangularChart, spectrumChart, channelResponseChart, reconstructedChart, samplingChart;
        let shapeFactorChart, discriminationFactorChart, bandRedundancyChart;
        let nondistortingChart, idealShapeChart, progressiveChart;
        let carrierTimeChart, carrierFreqChart, ssbTimeChart, ssbFreqChart, eyeChart;

        // Store data for interactive features
        let currentElements = [];
        let progressiveData = null;

        // Audio context for Morse code playback
        let audioContext = null;
        let isPlaying = false;
        let currentMorseCode = '';
        let audioSpeed = 1;
        let animationFrameId = null;

        // Sound effects enabled
        let soundEnabled = true;

        // ============ THEME TOGGLE ============
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
            playClickSound();
        }

        // Load saved theme
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        // ============ SOUND EFFECTS ============
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîá';
            localStorage.setItem('soundEnabled', soundEnabled);
        }

        // Load saved sound preference
        if (localStorage.getItem('soundEnabled') === 'false') {
            soundEnabled = false;
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('soundToggle').textContent = 'üîá';
            });
        }

        function playClickSound() {
            if (!soundEnabled) return;
            initAudio();
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.frequency.value = 800;
            osc.type = 'sine';
            gain.gain.setValueAtTime(0.1, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
            osc.start();
            osc.stop(audioContext.currentTime + 0.05);
        }

        function playSuccessSound() {
            if (!soundEnabled) return;
            initAudio();
            const notes = [523, 659, 784]; // C5, E5, G5
            notes.forEach((freq, i) => {
                setTimeout(() => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.frequency.value = freq;
                    osc.type = 'sine';
                    gain.gain.setValueAtTime(0.15, audioContext.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    osc.start();
                    osc.stop(audioContext.currentTime + 0.2);
                }, i * 100);
            });
        }

        function playErrorSound() {
            if (!soundEnabled) return;
            initAudio();
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.frequency.value = 200;
            osc.type = 'sawtooth';
            gain.gain.setValueAtTime(0.1, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            osc.start();
            osc.stop(audioContext.currentTime + 0.3);
        }

        // ============ CONFETTI CELEBRATION ============
        function launchConfetti() {
            const container = document.getElementById('confettiContainer');
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dfe6e9', '#fd79a8', '#a29bfe'];

            for (let i = 0; i < 150; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = (Math.random() * 10 + 5) + 'px';
                confetti.style.height = (Math.random() * 10 + 5) + 'px';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                confetti.style.animation = `confetti-fall ${Math.random() * 2 + 2}s ease-out forwards`;
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                container.appendChild(confetti);
            }

            // Clean up after animation
            setTimeout(() => {
                container.innerHTML = '';
            }, 4000);
        }

        // ============ PARTICLE EFFECTS ============
        function createParticle(x, y) {
            const container = document.getElementById('particleContainer');
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = x + 'px';
            particle.style.top = y + 'px';
            particle.style.background = `hsl(${Math.random() * 60 + 180}, 70%, 50%)`;
            container.appendChild(particle);

            setTimeout(() => particle.remove(), 3000);
        }

        // Create particles on mouse move (throttled)
        let lastParticleTime = 0;
        document.addEventListener('mousemove', (e) => {
            if (Date.now() - lastParticleTime > 50) {
                createParticle(e.clientX, e.clientY);
                lastParticleTime = Date.now();
            }
        });

        // ============ KEYBOARD SHORTCUTS ============
        document.addEventListener('keydown', (e) => {
            // Don't trigger if typing in an input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch(e.key.toLowerCase()) {
                case ' ':
                    e.preventDefault();
                    toggleAudio();
                    break;
                case 'd':
                    toggleTheme();
                    break;
                case 's':
                    toggleSound();
                    break;
                case 'enter':
                    analyzeSignal();
                    break;
            }
        });

        // ============ TYPING ANIMATION ============
        async function typeText(element, text, speed = 50) {
            element.innerHTML = '';
            const cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            element.appendChild(cursor);

            for (let i = 0; i < text.length; i++) {
                const char = document.createElement('span');
                char.textContent = text[i];
                char.style.opacity = '0';
                element.insertBefore(char, cursor);

                await new Promise(r => setTimeout(r, speed));
                char.style.opacity = '1';
                char.style.transition = 'opacity 0.1s';

                if (soundEnabled && text[i] !== ' ') {
                    playClickSound();
                }
            }

            // Remove cursor after typing
            setTimeout(() => cursor.remove(), 1000);
        }

        // Initialize audio context
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Play a beep tone
        function playTone(frequency, duration) {
            return new Promise(resolve => {
                initAudio();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration / 1000);

                setTimeout(resolve, duration);
            });
        }

        // Play Morse code audio
        async function playMorseCode(morse) {
            const dotDuration = 100 / audioSpeed;
            const dashDuration = 300 / audioSpeed;
            const gapDuration = 100 / audioSpeed;
            const letterGap = 300 / audioSpeed;
            const wordGap = 700 / audioSpeed;

            const keyLever = document.getElementById('keyLever');
            const keyLight = document.getElementById('keyLight');

            for (let i = 0; i < morse.length && isPlaying; i++) {
                const char = morse[i];

                if (char === '.') {
                    keyLever.classList.add('pressed');
                    keyLight.classList.add('on');
                    await playTone(700, dotDuration);
                    keyLever.classList.remove('pressed');
                    keyLight.classList.remove('on');
                    await new Promise(r => setTimeout(r, gapDuration));
                } else if (char === '-') {
                    keyLever.classList.add('pressed');
                    keyLight.classList.add('on');
                    await playTone(700, dashDuration);
                    keyLever.classList.remove('pressed');
                    keyLight.classList.remove('on');
                    await new Promise(r => setTimeout(r, gapDuration));
                } else if (char === ' ') {
                    if (i + 1 < morse.length && morse[i + 1] === ' ') {
                        await new Promise(r => setTimeout(r, wordGap));
                        i++;
                    } else {
                        await new Promise(r => setTimeout(r, letterGap));
                    }
                }
            }

            isPlaying = false;
            document.getElementById('playBtn').classList.remove('playing');
            document.getElementById('playIcon').textContent = '‚ñ∂';
        }

        // Toggle audio playback
        function toggleAudio() {
            if (isPlaying) {
                isPlaying = false;
                document.getElementById('playBtn').classList.remove('playing');
                document.getElementById('playIcon').textContent = '‚ñ∂';
            } else {
                isPlaying = true;
                document.getElementById('playBtn').classList.add('playing');
                document.getElementById('playIcon').textContent = '‚è∏';
                playMorseCode(currentMorseCode);
            }
        }

        // Update audio speed
        function updateAudioSpeed() {
            audioSpeed = parseFloat(document.getElementById('audioSpeed').value);
        }

        // Generate waveform display
        function generateWaveformBars(elements) {
            const container = document.getElementById('waveformDisplay');
            container.innerHTML = '';

            const maxBars = 60;
            const step = Math.max(1, Math.floor(elements.length / maxBars));

            for (let i = 0; i < elements.length && container.children.length < maxBars; i += step) {
                const bar = document.createElement('div');
                bar.className = 'waveform-bar';
                bar.style.height = (elements[i] * 30 + 5) + 'px';
                container.appendChild(bar);
            }
        }

        // Animate signal transmission
        function animateSignal(elements, duration = 5000) {
            const canvas = document.getElementById('signalCanvas');
            const ctx = canvas.getContext('2d');
            const dot = document.getElementById('signalDot');

            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            const startTime = Date.now();
            const totalPoints = elements.length;

            function draw() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const currentIndex = Math.floor(progress * totalPoints);

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Draw signal trace
                ctx.beginPath();
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 2;

                for (let i = 0; i <= currentIndex && i < totalPoints; i++) {
                    const x = (i / totalPoints) * canvas.width;
                    const y = canvas.height / 2 - (elements[i] - 0.5) * (canvas.height * 0.6);

                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();

                // Update dot position
                if (currentIndex < totalPoints) {
                    const x = (currentIndex / totalPoints) * canvas.width;
                    const y = canvas.height / 2 - (elements[currentIndex] - 0.5) * (canvas.height * 0.6);
                    dot.style.left = x + 'px';
                    dot.style.top = y + 'px';
                }

                if (progress < 1) {
                    animationFrameId = requestAnimationFrame(draw);
                }
            }

            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            draw();
        }

        // Animate transmission progress stages
        async function animateProgress() {
            const stages = ['stage1', 'stage2', 'stage3', 'stage4', 'stage5', 'stage6'];

            for (let i = 0; i < stages.length; i++) {
                // Set current stage as active
                document.getElementById(stages[i]).classList.add('active');

                await new Promise(r => setTimeout(r, 300));

                // Mark as complete and move to next
                document.getElementById(stages[i]).classList.remove('active');
                document.getElementById(stages[i]).classList.add('complete');
            }
        }

        // Chart configuration
        const chartConfig = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            animation: false,
            scales: {
                x: { grid: { color: '#e5e7eb' }, ticks: { maxTicksLimit: 10 } },
                y: { grid: { color: '#e5e7eb' } }
            },
            elements: { point: { radius: 0 }, line: { borderWidth: 2 } }
        };

        // Toggle step panels
        function toggleStep(num) {
            // Handle both 'step1', 'step2' format and direct IDs like 'summary'
            let step = document.getElementById('step' + num);
            if (!step) {
                step = document.getElementById(num);
            }
            if (step) {
                step.classList.toggle('open');
            }
        }

        // Toggle concept panels
        function toggleConcept(num) {
            const concept = document.getElementById('concept' + num);
            concept.classList.toggle('open');
        }

        // Show carrier tab
        function showCarrierTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('carrier-' + tab).classList.add('active');
        }

        // Update bandwidth display
        document.getElementById('bandwidth').addEventListener('input', function() {
            document.getElementById('bandwidthValue').textContent = this.value;
        });

        // Harmonic slider for progressive building
        document.getElementById('harmonicSlider').addEventListener('input', function() {
            document.getElementById('harmonicValue').textContent = this.value;
            if (progressiveData) {
                updateProgressiveChart(parseInt(this.value));
            }
        });

        // Main analysis function
        async function analyzeSignal() {
            const text = document.getElementById('inputText').value || 'SOS';
            const bandwidth = parseInt(document.getElementById('bandwidth').value);
            const channelType = document.getElementById('channelType').value;

            try {
                // Fetch all data in parallel
                const [analysisRes, shapeRes, bandRes, nondistRes, idealRes, progressRes, carrierRes, eyeRes] = await Promise.all([
                    fetch('/api/full_analysis', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text, bandwidth, channelType, samplesPerUnit: 50, numHarmonics: 30 })
                    }),
                    fetch('/api/shape_discrimination', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text, numHarmonics: 30 })
                    }),
                    fetch('/api/band_redundancy', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text, numHarmonics: 50 })
                    }),
                    fetch('/api/nondistorting_wave', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text, bandwidth })
                    }),
                    fetch('/api/ideal_shape_factors'),
                    fetch('/api/progressive_harmonics', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text, maxHarmonics: 25 })
                    }),
                    fetch('/api/carrier_modulation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text, carrierFreq: 10 })
                    }),
                    fetch('/api/eye_diagram', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text, bandwidth, channelType })
                    })
                ]);

                const data = await analysisRes.json();
                const shapeData = await shapeRes.json();
                const bandData = await bandRes.json();
                const nondistData = await nondistRes.json();
                const idealData = await idealRes.json();
                progressiveData = await progressRes.json();
                const carrierData = await carrierRes.json();
                const eyeData = await eyeRes.json();

                currentElements = data.step1_encoding.elements;
                currentMorseCode = data.step1_encoding.morse_code;

                // Show signal flow overview
                document.getElementById('signalFlowOverview').style.display = 'block';

                // Show step connectors
                const connectors = ['connector1-2', 'connector2-3', 'connector3-4', 'connector4-5', 'connector5-6', 'connector6-7'];
                connectors.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'flex';
                });

                // Animate flow steps
                animateFlowSteps();

                // Open all steps
                for (let i = 1; i <= 7; i++) {
                    document.getElementById('step' + i).classList.add('open');
                }

                // Step 1: Encoding
                updateStep1(data.step1_encoding);

                // Step 2: Rectangular wave
                updateStep2(data.step2_rectangular_wave, data.step1_encoding.elements);

                // Step 3: Fourier
                updateStep3(data.step3_fourier);

                // Step 4: Channel
                updateStep4(data.step4_channel);

                // Step 5: Reconstruction
                updateStep5(data.step2_rectangular_wave, data.step5_reconstruction);

                // Step 6: Sampling
                updateStep6(data.step5_reconstruction, data.step6_sampling, data.step1_encoding.elements);

                // Step 7: Results
                updateStep7(data);

                // Advanced Concepts
                updateShapeDiscrimination(shapeData);
                updateBandRedundancy(bandData);
                updateNondistorting(nondistData);
                updateIdealShapes(idealData);
                updateProgressiveChart(5);
                updateCarrierModulation(carrierData);
                updateEyeDiagram(eyeData);

            } catch (err) {
                console.error('Analysis error:', err);
            }
        }

        // Animate the flow steps to show progression
        function animateFlowSteps() {
            const flowSteps = document.querySelectorAll('.flow-step');
            flowSteps.forEach((step, index) => {
                step.classList.remove('active', 'complete');
            });

            let currentStep = 0;
            const interval = setInterval(() => {
                if (currentStep > 0) {
                    flowSteps[currentStep - 1].classList.remove('active');
                    flowSteps[currentStep - 1].classList.add('complete');
                }
                if (currentStep < flowSteps.length) {
                    flowSteps[currentStep].classList.add('active');
                    currentStep++;
                } else {
                    clearInterval(interval);
                }
            }, 400);
        }

        // Update flow step to show active state
        function setFlowStepActive(stepNum) {
            const flowSteps = document.querySelectorAll('.flow-step');
            flowSteps.forEach((step, index) => {
                if (index + 1 < stepNum) {
                    step.classList.add('complete');
                    step.classList.remove('active');
                } else if (index + 1 === stepNum) {
                    step.classList.add('active');
                    step.classList.remove('complete');
                } else {
                    step.classList.remove('active', 'complete');
                }
            });
        }

        function updateStep1(encoding) {
            const content = document.getElementById('step1-content');
            content.innerHTML = `
                <div style="margin-bottom: 16px;">
                    <strong>Input Text:</strong> "${encoding.text}"
                </div>
                <div style="margin-bottom: 12px;">
                    <strong>Morse Code:</strong>
                    <div class="morse-display">${encoding.morse}</div>
                </div>
                <div style="margin-bottom: 12px;">
                    <strong>Signal Elements (${encoding.elements.length} time units):</strong>
                    <div class="signal-elements">
                        ${encoding.elements.map(e => `<div class="signal-element ${e ? 'on' : 'off'}"></div>`).join('')}
                    </div>
                </div>
                <table>
                    <tr><th>Symbol</th><th>Duration</th><th>Representation</th></tr>
                    <tr><td>Dot (.)</td><td>1 unit</td><td>1</td></tr>
                    <tr><td>Dash (-)</td><td>3 units</td><td>1,1,1</td></tr>
                    <tr><td>Inter-element gap</td><td>1 unit</td><td>0</td></tr>
                    <tr><td>Letter gap</td><td>3 units</td><td>0,0,0</td></tr>
                    <tr><td>Word gap</td><td>7 units</td><td>0,0,0,0,0,0,0</td></tr>
                </table>
            `;
        }

        function updateStep2(wave, elements) {
            if (rectangularChart) rectangularChart.destroy();
            const labels = wave.signal.map((_, i) => (i / 50).toFixed(1));
            rectangularChart = new Chart(document.getElementById('rectangularChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: wave.signal,
                        borderColor: '#1e3a5f',
                        backgroundColor: 'rgba(30, 58, 95, 0.1)',
                        fill: true,
                        stepped: true
                    }]
                },
                options: {...chartConfig, scales: {...chartConfig.scales, y: {min: -0.2, max: 1.2}}}
            });

            // Update the input display if elements are provided
            if (elements && document.getElementById('step2-input')) {
                const binaryStr = elements.map(e => e.value).join('');
                document.getElementById('step2-input').textContent = `Binary: ${binaryStr}`;
            }
        }

        function updateStep3(fourier) {
            // Spectrum chart
            if (spectrumChart) spectrumChart.destroy();
            const displayComps = fourier.components.slice(0, 20);
            spectrumChart = new Chart(document.getElementById('spectrumChart'), {
                type: 'bar',
                data: {
                    labels: displayComps.map(c => c.k),
                    datasets: [{
                        data: displayComps.map(c => c.magnitude),
                        backgroundColor: displayComps.map(c => c.magnitude > 0.05 ? '#3b82f6' : '#cbd5e1')
                    }]
                },
                options: {...chartConfig, scales: {...chartConfig.scales, x: {title: {display: true, text: 'Harmonic (k)'}}}}
            });

            // Fourier table
            const tableHtml = `<table>
                <tr><th>k</th><th>a<sub>k</sub></th><th>b<sub>k</sub></th><th>|C<sub>k</sub>|</th></tr>
                ${fourier.components.slice(0, 10).map(c => `
                    <tr>
                        <td>${c.k}</td>
                        <td>${c.a_k.toFixed(4)}</td>
                        <td>${c.b_k.toFixed(4)}</td>
                        <td>${c.magnitude.toFixed(4)}</td>
                    </tr>
                `).join('')}
            </table>`;
            document.getElementById('fourierTable').innerHTML = tableHtml;
        }

        function updateStep4(channel) {
            // Channel response chart
            if (channelResponseChart) channelResponseChart.destroy();
            const freqs = channel.effects.slice(0, 25);
            channelResponseChart = new Chart(document.getElementById('channelResponseChart'), {
                type: 'bar',
                data: {
                    labels: freqs.map(e => e.harmonic),
                    datasets: [{
                        label: 'Attenuation',
                        data: freqs.map(e => e.attenuation),
                        backgroundColor: freqs.map(e => e.attenuation > 0.5 ? '#10b981' : e.attenuation > 0 ? '#f59e0b' : '#ef4444')
                    }]
                },
                options: {...chartConfig, scales: {...chartConfig.scales, y: {min: 0, max: 1.1}}}
            });

            document.getElementById('step4-content').innerHTML = `
                <div class="info-panel">
                    <strong>Channel:</strong> ${channel.channel_type} filter with bandwidth B = ${channel.bandwidth}<br>
                    <strong>Effect:</strong> Harmonics k > ${channel.bandwidth} are ${channel.channel_type === 'ideal' ? 'completely blocked' : 'attenuated'}
                </div>
            `;
        }

        function updateStep5(original, reconstructed) {
            if (reconstructedChart) reconstructedChart.destroy();
            const labels = original.signal.map((_, i) => (i / 50).toFixed(1));
            reconstructedChart = new Chart(document.getElementById('reconstructedChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Original',
                            data: original.signal,
                            borderColor: '#d1d5db',
                            borderWidth: 1,
                            stepped: true,
                            fill: false
                        },
                        {
                            label: 'Reconstructed',
                            data: reconstructed.signal,
                            borderColor: '#059669',
                            borderWidth: 2,
                            fill: false
                        }
                    ]
                },
                options: {...chartConfig, plugins: {legend: {display: true, position: 'top'}}}
            });

            document.getElementById('step5-content').innerHTML = `
                <div class="info-panel">
                    <strong>Observation:</strong> The reconstructed signal (green) shows rounding at transitions
                    due to missing high-frequency components. However, at sampling instants (center of each time unit),
                    the value should still be close to the original if bandwidth is sufficient.
                </div>
            `;
        }

        function updateStep6(reconstructed, sampling, originalElements) {
            if (samplingChart) samplingChart.destroy();
            const labels = reconstructed.signal.map((_, i) => (i / 50).toFixed(1));

            // Create sampling points dataset
            const samplingPoints = [];
            const samplingLabels = [];
            sampling.samples.forEach(s => {
                samplingPoints.push({x: s.sample_index, y: s.value});
            });

            samplingChart = new Chart(document.getElementById('samplingChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Received Signal',
                            data: reconstructed.signal,
                            borderColor: '#3b82f6',
                            borderWidth: 1.5,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Threshold (0.5)',
                            data: Array(reconstructed.signal.length).fill(0.5),
                            borderColor: '#ef4444',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Sample Points',
                            data: sampling.samples.map(s => ({x: (s.sample_index / 50).toFixed(1), y: s.value})),
                            borderColor: 'transparent',
                            backgroundColor: sampling.samples.map((s, i) =>
                                s.decoded === originalElements[i] ? '#10b981' : '#ef4444'),
                            pointRadius: 6,
                            showLine: false,
                            type: 'scatter'
                        }
                    ]
                },
                options: {...chartConfig, plugins: {legend: {display: true, position: 'top'}}}
            });

            // Calculate decoded bits and error status
            const decodedBits = sampling.samples.map(s => s.decoded);
            const originalBits = originalElements.map(e => e.value !== undefined ? e.value : e);
            const errors = decodedBits.filter((d, i) => d !== originalBits[i]).length;

            document.getElementById('step6-content').innerHTML = `
                <div class="info-panel">
                    <strong>Sampling:</strong> At the center of each time unit, we sample the received signal
                    and compare to threshold 0.5.<br>
                    <strong>Decision:</strong> If sample > 0.5 ‚Üí decoded as 1, otherwise ‚Üí decoded as 0<br>
                    <span style="color: #10b981;">‚óè Green = correctly decoded</span>,
                    <span style="color: #ef4444;">‚óè Red = error</span>
                </div>
            `;

            // Update step 6 output display
            const step6Output = document.getElementById('step6-output');
            if (step6Output) {
                const decodedStr = decodedBits.join('');
                if (errors === 0) {
                    step6Output.innerHTML = `Binary: ${decodedStr} <span style="color: #10b981;">‚úì Perfect!</span>`;
                } else {
                    step6Output.innerHTML = `Binary: ${decodedStr} <span style="color: #ef4444;">(${errors} error${errors > 1 ? 's' : ''})</span>`;
                }
            }
        }

        function updateStep7(data) {
            const analysis = data.step7_analysis;
            const encoding = data.step1_encoding;
            const nyquist = data.nyquist_info;

            const isSuccess = analysis.success;

            document.getElementById('step7-content').innerHTML = `
                <div class="result-panel ${isSuccess ? 'success' : 'error'}">
                    <strong>${isSuccess ? 'Transmission Successful' : 'Transmission Errors Detected'}</strong><br>
                    Errors: ${analysis.errors} out of ${encoding.elements.length} elements
                    (${(analysis.error_rate * 100).toFixed(1)}% error rate)
                </div>

                <div class="two-col">
                    <div>
                        <h4 style="margin-bottom: 12px; color: #374151;">Nyquist's Key Result</h4>
                        <div class="formula-box">
                            <div class="formula">S<sub>max</sub> = 2B symbols/second</div>
                            <div class="explanation">Maximum signaling speed through a channel of bandwidth B Hz</div>
                        </div>
                        <p style="font-size: 0.9em; color: #6b7280; margin-top: 8px;">
                            This means for a bandwidth of ${data.step4_channel.bandwidth} Hz,
                            you can transmit up to ${data.step4_channel.bandwidth * 2} symbols/second
                            without intersymbol interference at sampling instants.
                        </p>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 12px; color: #374151;">Intersymbol Interference (ISI)</h4>
                        <table>
                            <tr><th>Element</th><th>Sampled Value</th><th>Expected</th><th>ISI</th></tr>
                            ${analysis.isi.slice(0, 8).map(item => `
                                <tr>
                                    <td>${item.element}</td>
                                    <td>${item.actual_value.toFixed(3)}</td>
                                    <td>${item.ideal_value}</td>
                                    <td>${item.isi_percent.toFixed(1)}%</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                </div>

                <div class="info-panel" style="margin-top: 16px;">
                    <strong>Physical Interpretation:</strong> When bandwidth is limited, sharp transitions in the
                    rectangular wave get "smeared" across time, causing interference between adjacent symbols.
                    Nyquist showed that special pulse shapes (like the sinc function) can achieve zero ISI at
                    sampling instants while using minimum bandwidth.
                </div>
            `;
        }

        // ========== Advanced Concept Update Functions ==========

        function updateShapeDiscrimination(data) {
            // Shape Factor Chart
            if (shapeFactorChart) shapeFactorChart.destroy();
            const shapeData = data.shape_factors.slice(0, 20);
            shapeFactorChart = new Chart(document.getElementById('shapeFactorChart'), {
                type: 'bar',
                data: {
                    labels: shapeData.map(s => s.k),
                    datasets: [{
                        data: shapeData.map(s => s.magnitude),
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {...chartConfig, scales: {...chartConfig.scales,
                    x: {title: {display: true, text: 'Harmonic k'}},
                    y: {title: {display: true, text: '|F(œâ)|'}}
                }}
            });

            // Discrimination Factor Chart
            if (discriminationFactorChart) discriminationFactorChart.destroy();
            const discData = data.discrimination_factors.slice(0, 20);
            discriminationFactorChart = new Chart(document.getElementById('discriminationFactorChart'), {
                type: 'bar',
                data: {
                    labels: discData.map(d => d.k),
                    datasets: [{
                        data: discData.map(d => d.magnitude),
                        backgroundColor: '#10b981'
                    }]
                },
                options: {...chartConfig, scales: {...chartConfig.scales,
                    x: {title: {display: true, text: 'Harmonic k'}},
                    y: {title: {display: true, text: '|D(œâ)|'}}
                }}
            });

            document.getElementById('concept1-content').innerHTML = `
                <div class="info-panel">
                    <strong>Key Insight:</strong> ${data.explanation.key_insight}
                </div>
            `;
        }

        function updateBandRedundancy(data) {
            if (bandRedundancyChart) bandRedundancyChart.destroy();

            // Create grouped bar chart showing bands
            const bands = data.bands;
            const datasets = bands.map((band, idx) => ({
                label: `Band ${band.band_index} (${band.frequency_range})`,
                data: band.components.map(c => c.magnitude),
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'][idx % 5]
            }));

            const maxLen = Math.max(...bands.map(b => b.components.length));
            const labels = Array.from({length: maxLen}, (_, i) => i);

            bandRedundancyChart = new Chart(document.getElementById('bandRedundancyChart'), {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    ...chartConfig,
                    plugins: {legend: {display: true, position: 'top'}},
                    scales: {
                        x: {title: {display: true, text: 'Position in Band'}},
                        y: {title: {display: true, text: 'Magnitude'}}
                    }
                }
            });

            document.getElementById('bandRedundancyContent').innerHTML = `
                <div class="info-panel">
                    <strong>Observation:</strong> Notice how the magnitude pattern repeats across bands.
                    Signaling speed = ${data.signaling_speed} elements, so bands of width ${data.signaling_speed}
                    contain redundant information.
                </div>
            `;
        }

        function updateNondistorting(data) {
            if (nondistortingChart) nondistortingChart.destroy();

            const original = data.original;
            const labels = original.map((_, i) => (i / 50).toFixed(1));

            const datasets = [
                {
                    label: 'Original',
                    data: original,
                    borderColor: '#1f2937',
                    borderWidth: 1,
                    stepped: true
                }
            ];

            data.waves.forEach((wave, idx) => {
                const colors = ['#3b82f6', '#f59e0b', '#10b981'];
                datasets.push({
                    label: `B=${wave.bandwidth} (${wave.is_nondistorting ? 'OK' : wave.errors + ' errors'})`,
                    data: wave.signal,
                    borderColor: colors[idx % 3],
                    borderWidth: 1.5,
                    borderDash: wave.is_nondistorting ? [] : [5, 5]
                });
            });

            nondistortingChart = new Chart(document.getElementById('nondistortingChart'), {
                type: 'line',
                data: { labels, datasets },
                options: {
                    ...chartConfig,
                    plugins: {legend: {display: true, position: 'top'}}
                }
            });

            document.getElementById('nondistortingContent').innerHTML = `
                <div class="concept-grid">
                    ${data.waves.map(w => `
                        <div class="concept-card">
                            <h4>Bandwidth = ${w.bandwidth}</h4>
                            <p>Errors: ${w.errors}</p>
                            <p>Status: <span class="status-badge ${w.is_nondistorting ? 'good' : 'poor'}">
                                ${w.is_nondistorting ? 'Nondistorting' : 'Distorting'}
                            </span></p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateIdealShapes(data) {
            if (idealShapeChart) idealShapeChart.destroy();

            const shapes = data.shapes;
            const datasets = shapes.map((shape, idx) => ({
                label: shape.name,
                data: shape.y,
                borderColor: ['#1e3a5f', '#3b82f6', '#10b981', '#f59e0b'][idx % 4],
                borderWidth: idx === 0 ? 2 : 1.5,
                fill: false,
                pointRadius: 0
            }));

            idealShapeChart = new Chart(document.getElementById('idealShapeChart'), {
                type: 'line',
                data: {
                    labels: shapes[0].x.map(x => x.toFixed(2)),
                    datasets
                },
                options: {
                    ...chartConfig,
                    plugins: {legend: {display: true, position: 'top'}},
                    scales: {
                        x: {title: {display: true, text: 'Normalized Frequency (œâ/œâ_s)'}},
                        y: {title: {display: true, text: 'H(œâ)'}}
                    }
                }
            });

            document.getElementById('idealShapeContent').innerHTML = `
                <div class="concept-grid">
                    ${shapes.map(s => `
                        <div class="concept-card">
                            <h4>${s.name}</h4>
                            <p>${s.description}</p>
                            <p style="font-family: 'Times New Roman', serif; color: #1e3a5f;">${s.formula}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateProgressiveChart(numHarmonics) {
            if (!progressiveData) return;
            if (progressiveChart) progressiveChart.destroy();

            const original = progressiveData.original;
            const step = progressiveData.steps.find(s => s.num_harmonics >= numHarmonics) ||
                         progressiveData.steps[progressiveData.steps.length - 1];

            const labels = original.map((_, i) => (i / 50).toFixed(1));

            progressiveChart = new Chart(document.getElementById('progressiveChart'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Original',
                            data: original,
                            borderColor: '#d1d5db',
                            borderWidth: 1,
                            stepped: true
                        },
                        {
                            label: `${step.num_harmonics} harmonics`,
                            data: step.signal,
                            borderColor: step.errors === 0 ? '#10b981' : '#ef4444',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    ...chartConfig,
                    plugins: {legend: {display: true, position: 'top'}}
                }
            });

            document.getElementById('progressiveContent').innerHTML = `
                <div class="info-panel">
                    <strong>Harmonics:</strong> ${step.num_harmonics} |
                    <strong>MSE:</strong> ${step.mse.toFixed(4)} |
                    <strong>Errors:</strong> ${step.errors} |
                    <strong>Nyquist Ratio:</strong> ${step.nyquist_ratio.toFixed(2)} |
                    <span class="status-badge ${step.bandwidth_sufficient ? 'good' : 'poor'}">
                        ${step.bandwidth_sufficient ? 'Sufficient BW' : 'Insufficient BW'}
                    </span>
                </div>
            `;
        }

        function updateCarrierModulation(data) {
            // Time domain chart
            if (carrierTimeChart) carrierTimeChart.destroy();
            const timeLabels = data.time.slice(0, 200).map(t => t.toFixed(2));

            carrierTimeChart = new Chart(document.getElementById('carrierTimeChart'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        {
                            label: 'Baseband',
                            data: data.baseband.slice(0, 200),
                            borderColor: '#6b7280',
                            borderWidth: 1,
                            pointRadius: 0
                        },
                        {
                            label: 'Carrier',
                            data: data.carrier.slice(0, 200),
                            borderColor: '#3b82f6',
                            borderWidth: 1,
                            pointRadius: 0
                        },
                        {
                            label: 'Modulated (AM)',
                            data: data.modulated.slice(0, 200),
                            borderColor: '#10b981',
                            borderWidth: 1.5,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    ...chartConfig,
                    plugins: {legend: {display: true, position: 'top'}}
                }
            });

            // Frequency domain chart
            if (carrierFreqChart) carrierFreqChart.destroy();
            carrierFreqChart = new Chart(document.getElementById('carrierFreqChart'), {
                type: 'bar',
                data: {
                    labels: data.frequencies.map(f => f.toFixed(1)),
                    datasets: [
                        {
                            label: 'Modulated Spectrum',
                            data: data.modulated_spectrum,
                            backgroundColor: '#10b981'
                        }
                    ]
                },
                options: {
                    ...chartConfig,
                    plugins: {legend: {display: true}},
                    scales: {
                        x: {title: {display: true, text: 'Frequency'}},
                        y: {title: {display: true, text: 'Magnitude'}}
                    }
                }
            });

            document.getElementById('carrierContent').innerHTML = `
                <div class="info-panel">
                    <strong>Carrier Frequency:</strong> ${data.carrier_frequency} |
                    <strong>Observation:</strong> Upper and lower sidebands are visible around the carrier.
                    ${data.explanation.bandwidth}
                </div>
            `;
        }

        function updateEyeDiagram(data) {
            if (eyeChart) eyeChart.destroy();

            if (!data.traces || data.traces.length === 0) {
                document.getElementById('eyeMetrics').innerHTML = '<p>No eye diagram data</p>';
                return;
            }

            const labels = data.time_axis;
            const datasets = data.traces.slice(0, 20).map((trace, idx) => ({
                data: trace,
                borderColor: `rgba(59, 130, 246, ${0.3 + idx * 0.03})`,
                borderWidth: 1,
                pointRadius: 0,
                fill: false
            }));

            eyeChart = new Chart(document.getElementById('eyeChart'), {
                type: 'line',
                data: { labels, datasets },
                options: {
                    ...chartConfig,
                    plugins: {legend: {display: false}},
                    scales: {
                        x: {
                            grid: {color: 'rgba(255,255,255,0.1)'},
                            ticks: {color: '#9ca3af'},
                            title: {display: true, text: 'Time (samples)', color: '#9ca3af'}
                        },
                        y: {
                            grid: {color: 'rgba(255,255,255,0.1)'},
                            ticks: {color: '#9ca3af'},
                            min: -0.5,
                            max: 1.5
                        }
                    }
                }
            });

            const m = data.metrics;
            document.getElementById('eyeMetrics').innerHTML = `
                <table>
                    <tr><th>Metric</th><th>Value</th></tr>
                    <tr><td>Eye Height</td><td>${m.eye_height.toFixed(3)}</td></tr>
                    <tr><td>Eye Opening</td><td>${m.eye_opening_percent.toFixed(1)}%</td></tr>
                    <tr><td>Min High</td><td>${m.min_high.toFixed(3)}</td></tr>
                    <tr><td>Max Low</td><td>${m.max_low.toFixed(3)}</td></tr>
                    <tr><td>Quality</td><td><span class="status-badge ${m.quality.toLowerCase()}">${m.quality}</span></td></tr>
                </table>
            `;
        }

        // ============ QUIZ FUNCTIONALITY ============
        const quizQuestions = [
            {
                question: "What is the Nyquist Rate formula?",
                options: ["S = B", "S = 2B", "S = B/2", "S = 4B"],
                correct: 1,
                explanation: "The Nyquist Rate states that maximum signaling speed S = 2B, where B is the bandwidth in Hz."
            },
            {
                question: "What does 'nondistorting wave' mean in Nyquist's paper?",
                options: [
                    "A wave that never changes shape",
                    "A wave that produces correct values at sampling instants",
                    "A wave with no harmonics",
                    "A perfectly rectangular wave"
                ],
                correct: 1,
                explanation: "A nondistorting wave may be deformed, but produces correct values at the sampling instants."
            },
            {
                question: "Why does carrier wave (AM) telegraphy require twice the bandwidth?",
                options: [
                    "Because of noise",
                    "Because of the carrier frequency",
                    "Because it creates upper and lower sidebands",
                    "Because of phase distortion"
                ],
                correct: 2,
                explanation: "AM modulation creates both upper and lower sidebands around the carrier, doubling bandwidth."
            },
            {
                question: "What is the Shape Factor F(œâ) in Nyquist's analysis?",
                options: [
                    "The message being transmitted",
                    "The channel response",
                    "A factor depending only on the wave form",
                    "The noise level"
                ],
                correct: 2,
                explanation: "The Shape Factor depends only on the wave form, not on the intelligence (message) transmitted."
            },
            {
                question: "What is 'band redundancy' in telegraph transmission?",
                options: [
                    "Using multiple frequency bands for reliability",
                    "Frequency bands of width S contain identical information",
                    "Transmitting the same message twice",
                    "Using backup channels"
                ],
                correct: 1,
                explanation: "Nyquist showed that frequency bands of width equal to signaling speed contain redundant information."
            },
            {
                question: "In Morse code, how many time units is a dash?",
                options: ["1 unit", "2 units", "3 units", "5 units"],
                correct: 2,
                explanation: "A dash is 3 time units, while a dot is 1 time unit."
            },
            {
                question: "What technique recovers bandwidth efficiency in carrier telegraphy?",
                options: [
                    "Amplitude modulation",
                    "Single Sideband (SSB)",
                    "Frequency doubling",
                    "Phase inversion"
                ],
                correct: 1,
                explanation: "Single Sideband transmission removes one sideband, recovering the bandwidth efficiency of DC telegraphy."
            },
            {
                question: "What does the Eye Diagram visualize?",
                options: [
                    "Frequency spectrum",
                    "Intersymbol Interference (ISI)",
                    "Carrier frequency",
                    "Noise level"
                ],
                correct: 1,
                explanation: "The Eye Diagram overlays symbol periods to visualize ISI and signal quality."
            }
        ];

        let currentQuestionIndex = 0;
        let quizScore = 0;
        let quizAnswered = false;

        function startQuiz() {
            currentQuestionIndex = 0;
            quizScore = 0;
            quizAnswered = false;
            document.getElementById('quizScore').textContent = '';
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex >= quizQuestions.length) {
                showQuizResults();
                return;
            }

            const q = quizQuestions[currentQuestionIndex];
            document.getElementById('quizQuestion').textContent = `Q${currentQuestionIndex + 1}/${quizQuestions.length}: ${q.question}`;

            const optionsDiv = document.getElementById('quizOptions');
            optionsDiv.innerHTML = q.options.map((opt, i) => `
                <button class="quiz-option" onclick="selectAnswer(${i})" style="
                    padding: 12px 16px;
                    border: 2px solid #e5e7eb;
                    border-radius: 6px;
                    background: white;
                    text-align: left;
                    cursor: pointer;
                    transition: all 0.2s;
                " onmouseover="this.style.borderColor='#1e3a5f'" onmouseout="this.style.borderColor='#e5e7eb'">
                    ${String.fromCharCode(65 + i)}. ${opt}
                </button>
            `).join('');

            document.getElementById('quizFeedback').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'none';
            quizAnswered = false;
        }

        function selectAnswer(index) {
            if (quizAnswered) return;
            quizAnswered = true;

            const q = quizQuestions[currentQuestionIndex];
            const buttons = document.querySelectorAll('.quiz-option');
            const feedback = document.getElementById('quizFeedback');

            buttons.forEach((btn, i) => {
                btn.style.cursor = 'default';
                if (i === q.correct) {
                    btn.style.background = '#ecfdf5';
                    btn.style.borderColor = '#10b981';
                    btn.style.transform = 'scale(1.02)';
                } else if (i === index && index !== q.correct) {
                    btn.style.background = '#fef2f2';
                    btn.style.borderColor = '#ef4444';
                    btn.style.animation = 'shake 0.5s ease';
                }
            });

            if (index === q.correct) {
                quizScore++;
                feedback.style.background = '#ecfdf5';
                feedback.style.color = '#065f46';
                feedback.innerHTML = `<strong>‚úì Correct!</strong> ${q.explanation}`;
                playSuccessSound();
            } else {
                feedback.style.background = '#fef2f2';
                feedback.style.color = '#991b1b';
                feedback.innerHTML = `<strong>‚úó Incorrect.</strong> ${q.explanation}`;
                playErrorSound();
            }

            feedback.style.display = 'block';
            document.getElementById('nextBtn').style.display = 'inline-block';
        }

        function nextQuestion() {
            currentQuestionIndex++;
            showQuestion();
        }

        function showQuizResults() {
            const percentage = Math.round((quizScore / quizQuestions.length) * 100);
            let message, color, emoji;

            if (percentage >= 80) {
                message = "Excellent! You've mastered Nyquist's theory!";
                color = '#10b981';
                emoji = 'üèÜ';
                launchConfetti();
                playSuccessSound();
            } else if (percentage >= 60) {
                message = "Good job! Review the concepts you missed.";
                color = '#f59e0b';
                emoji = 'üëç';
            } else {
                message = "Keep studying! Try the visualization again.";
                color = '#ef4444';
                emoji = 'üìö';
            }

            document.getElementById('quizQuestion').textContent = 'Quiz Complete!';
            document.getElementById('quizOptions').innerHTML = '';
            document.getElementById('quizFeedback').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('quizScore').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 4em; margin-bottom: 10px;">${emoji}</div>
                    <div style="font-size: 3.5em; color: ${color}; font-weight: 700;">${percentage}%</div>
                    <div style="font-size: 1.3em; margin: 16px 0; color: var(--text-secondary);">${quizScore} out of ${quizQuestions.length} correct</div>
                    <div style="color: ${color}; font-size: 1.1em; font-weight: 600;">${message}</div>
                </div>
            `;
        }

        // ============ MORSE CODE PRACTICE ============
        const morseAlphabet = {
            'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.',
            'G': '--.', 'H': '....', 'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..',
            'M': '--', 'N': '-.', 'O': '---', 'P': '.--.', 'Q': '--.-', 'R': '.-.',
            'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-',
            'Y': '-.--', 'Z': '--..'
        };

        let practiceAnswer = '';
        let practiceCorrect = 0;
        let practiceTotal = 0;

        function newPracticeQuestion() {
            const letters = Object.keys(morseAlphabet);
            practiceAnswer = letters[Math.floor(Math.random() * letters.length)];
            const morse = morseAlphabet[practiceAnswer];

            // Display with visual dots and dashes
            const display = morse.split('').map(c => c === '.' ? '¬∑' : '‚Äî').join(' ');
            document.getElementById('practiceDisplay').textContent = display;
            document.getElementById('practiceInput').value = '';
            document.getElementById('practiceFeedback').textContent = '';
            document.getElementById('practiceInput').focus();
        }

        function checkPracticeAnswer(event) {
            const input = document.getElementById('practiceInput').value.toUpperCase();
            if (input.length === 0) return;

            practiceTotal++;
            const feedback = document.getElementById('practiceFeedback');
            const display = document.getElementById('practiceDisplay');

            if (input === practiceAnswer) {
                practiceCorrect++;
                feedback.textContent = '‚úì Correct!';
                feedback.style.color = '#10b981';
                display.style.boxShadow = '0 0 20px #10b981';
                playSuccessSound();

                // Streak celebration
                if (practiceCorrect > 0 && practiceCorrect % 5 === 0) {
                    launchConfetti();
                }
            } else {
                feedback.textContent = `‚úó It was "${practiceAnswer}"`;
                feedback.style.color = '#ef4444';
                display.style.boxShadow = '0 0 20px #ef4444';
                playErrorSound();
            }

            document.getElementById('practiceCorrect').textContent = practiceCorrect;
            document.getElementById('practiceTotal').textContent = practiceTotal;

            // Update accuracy display
            const accuracy = practiceTotal > 0 ? Math.round((practiceCorrect / practiceTotal) * 100) : 0;
            document.getElementById('practiceScore').innerHTML = `
                Score: <span id="practiceCorrect">${practiceCorrect}</span> / <span id="practiceTotal">${practiceTotal}</span>
                <span style="margin-left: 12px; color: ${accuracy >= 70 ? '#10b981' : accuracy >= 50 ? '#f59e0b' : '#ef4444'};">(${accuracy}% accuracy)</span>
            `;

            // Auto-advance after a short delay
            setTimeout(() => {
                display.style.boxShadow = 'inset 0 2px 4px rgba(0,0,0,0.3)';
                newPracticeQuestion();
            }, 1200);
        }

        async function playPracticeCode() {
            if (!practiceAnswer) return;
            const morse = morseAlphabet[practiceAnswer];

            initAudio();
            const dotDuration = 100;
            const dashDuration = 300;
            const gapDuration = 100;

            for (let char of morse) {
                if (char === '.') {
                    await playTone(700, dotDuration);
                    await new Promise(r => setTimeout(r, gapDuration));
                } else if (char === '-') {
                    await playTone(700, dashDuration);
                    await new Promise(r => setTimeout(r, gapDuration));
                }
            }
        }

        // Initialize quiz and practice on page load
        document.addEventListener('DOMContentLoaded', function() {
            startQuiz();
            newPracticeQuestion();
        });
    </script>
</body>
</html>
